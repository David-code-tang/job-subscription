'use client'

import { useEffect, useState } from 'react'
import { SheetComponent } from '@antv/s2-react'
// Temporarily remove CSS import due to LESS compilation issues
// TODO: Add custom CSS styles for the table
// import '@antv/s2-react/dist/style.min.css'

interface Job {
  id: string
  type: string
  company: string
  title: string
  updated_date: string | null
  department: string | null
  link: string | null
  location: string | null
}

export function S2Table() {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [jobs, setJobs] = useState<Job[]>([])

  useEffect(() => {
    async function fetchJobs() {
      try {
        const response = await fetch('/api/jobs')

        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login?redirect=/dashboard'
            return
          }
          if (response.status === 403) {
            window.location.href = '/pricing'
            return
          }
          throw new Error('Failed to load jobs')
        }

        const data = await response.json()
        setJobs(data.jobs || [])
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error')
      } finally {
        setLoading(false)
      }
    }

    fetchJobs()
  }, [])

  if (loading) {
    return (
      <div className="w-full h-[calc(100vh-140px)] flex items-center justify-center bg-white rounded-lg border">
        <div className="text-gray-500">加载中...</div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="w-full h-[calc(100vh-140px)] flex items-center justify-center bg-white rounded-lg border">
        <div className="text-center max-w-md">
          <div className="text-red-500 mb-4">
            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div className="text-red-600 font-medium mb-2">加载失败</div>
          <div className="text-gray-600 text-sm">{error}</div>
        </div>
      </div>
    )
  }

  // 空状态
  if (jobs.length === 0) {
    return (
      <div className="w-full h-[calc(100vh-140px)] flex items-center justify-center bg-white rounded-lg border">
        <div className="text-center max-w-md px-6">
          <div className="text-gray-400 mb-4">
            <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <div className="text-gray-700 font-medium mb-2">暂无数据</div>
          <div className="text-gray-600 text-sm mb-4">
            岗位信息库正在同步中，请稍后再试
          </div>
          <div className="text-xs text-gray-500">
            如需手动同步，请联系管理员访问 /admin/sync
          </div>
        </div>
      </div>
    )
  }

  // 转换数据为 S2 需要的格式
  const s2Data = jobs.map(job => ({
    id: job.id,
    '行业': job.type,
    '公司': job.company,
    '岗位名称': job.title,
    '部门': job.department || '-',
    '地点': job.location || '-',
    '更新日期': job.updated_date || '-',
    '链接': job.link || '-',
  }))

  // S2 数据配置
  const dataCfg = {
    fields: {
      columns: ['行业', '公司', '岗位名称', '部门', '地点', '更新日期', '链接'],
    },
    data: s2Data,
  }

  // S2 选项配置 - 飞书风格
  const options = {
    width: '100%',
    height: 'calc(100vh-140px)',
    showSeriesNumber: true,
    // 飞书风格配色
    theme: {
      name: 'default',
      background: '#ffffff',
      cornerCell: {
        backgroundColor: '#f5f6f7',
        bolderColor: '#dddddd',
        color: '#1f2329',
        fontSize: 14,
        fontWeight: 'normal',
      },
      rowCell: {
        backgroundColor: '#ffffff',
        backgroundColorDisable: '#f5f6f7',
        backgroundColorFocus: '#e8f3ff',
        bolderColor: '#dee2e6',
        color: '#1f2329',
        colorDisable: '#8f959e',
        colorFocus: '#0066ff',
        fontSize: 14,
        fontWeight: 'normal',
      },
      colCell: {
        backgroundColor: '#f5f6f7',
        backgroundColorFocus: '#e8f3ff',
        bolderColor: '#dee2e6',
        color: '#1f2329',
        colorFocus: '#0066ff',
        fontSize: 14,
        fontWeight: 500,
      },
      dataCell: {
        backgroundColor: '#ffffff',
        backgroundColorFocus: '#e8f3ff',
        bolderColor: '#dee2e6',
        color: '#1f2329',
        fontSize: 14,
      },
      scrollBar: {
        thumbColor: '#c9cdd4',
        thumbHoverColor: '#a8abb2',
        trackColor: '#f5f6f7',
      },
    },
    // 交互配置
    interaction: {
      hoverHighlight: true,
      linkFields: ['链接'],
    },
    // 显示配置
    pagination: {
      pageSize: 20,
      current: 1,
    },
    // 样式配置
    style: {
      layoutWidthType: 'compact',
      cellCfg: {
        height: 40,
      },
    },
  }

  return (
    <div className="w-full bg-white rounded-lg border overflow-hidden">
      <SheetComponent
        dataCfg={dataCfg}
        options={options}
        sheetType="table"
        header={{
          title: '岗位信息库',
          export: false,
          advanced: false,
        }}
      />
    </div>
  )
}
