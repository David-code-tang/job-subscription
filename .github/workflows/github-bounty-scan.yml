name: GitHub Bounty Scan

on:
  workflow_dispatch:
  schedule:
    - cron: "20 */6 * * *"

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID"
            exit 1
          fi

      - name: Search bounty issues and build message
        id: build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.parse
          import urllib.request
          from datetime import datetime, timedelta, timezone

          queries = [
              'is:issue is:open bounty documentation in:title,body',
              'is:issue is:open bounty translation in:title,body',
              'is:issue is:open "bounty $" in:title,body',
              'is:issue is:open bounty copywriter in:title,body',
          ]

          token = os.environ["GITHUB_TOKEN"]
          headers = {
              "Accept": "application/vnd.github+json",
              "Authorization": f"Bearer {token}",
              "X-GitHub-Api-Version": "2022-11-28",
          }

          now = datetime.now(timezone.utc)
          cutoff = now - timedelta(days=14)
          pool = {}

          for q in queries:
              url = "https://api.github.com/search/issues?" + urllib.parse.urlencode({"q": q, "per_page": 20})
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=20) as resp:
                  payload = json.loads(resp.read().decode("utf-8"))
              for item in payload.get("items", []):
                  updated = datetime.fromisoformat(item["updated_at"].replace("Z", "+00:00"))
                  if updated < cutoff:
                      continue
                  key = item["html_url"]
                  pool[key] = {
                      "title": item["title"],
                      "url": item["html_url"],
                      "updated": item["updated_at"][:10],
                      "repo": item["repository_url"].split("/repos/")[-1],
                  }

          items = sorted(pool.values(), key=lambda x: x["updated"], reverse=True)[:8]
          lines = [f"[GitHub Bounty Scan] {now.strftime('%Y-%m-%d %H:%M UTC')}", f"matches={len(items)}"]
          if not items:
              lines.append("- No recent bounty issues matched.")
          else:
              for idx, it in enumerate(items, 1):
                  lines.append(f"{idx}. {it['title']}")
                  lines.append(f"   repo: {it['repo']} | updated: {it['updated']}")
                  lines.append(f"   {it['url']}")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write("message<<EOF\n")
              f.write("\n".join(lines))
              f.write("\nEOF\n")
          PY

      - name: Send Telegram digest
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MESSAGE: ${{ steps.build.outputs.message }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            --data-urlencode "disable_web_page_preview=true"
