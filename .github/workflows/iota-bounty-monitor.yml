name: IOTA Bounty Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "10 * * * *"

permissions:
  contents: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID"
            exit 1
          fi

      - name: Build status message
        id: status
        run: |
          python - <<'PY'
          import json
          import urllib.request
          from datetime import datetime, timezone

          issue_url = "https://api.github.com/repos/iotaledger/iota-rust-sdk/issues/498"
          pr_url = "https://api.github.com/repos/iotaledger/iota-rust-sdk/pulls/569"

          def get(url):
              req = urllib.request.Request(
                  url,
                  headers={
                      "Accept": "application/vnd.github+json",
                      "X-GitHub-Api-Version": "2022-11-28",
                      "User-Agent": "job-subscription-monitor",
                  },
              )
              with urllib.request.urlopen(req, timeout=20) as resp:
                  return json.loads(resp.read().decode("utf-8"))

          issue = get(issue_url)
          pr = get(pr_url)

          now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M UTC")
          issue_state = issue.get("state", "unknown")
          pr_state = pr.get("state", "unknown")
          pr_merged = bool(pr.get("merged", False))
          mergeable_state = pr.get("mergeable_state", "unknown")
          review_comments = pr.get("review_comments", 0)
          comments = pr.get("comments", 0)
          commits = pr.get("commits", 0)
          changed_files = pr.get("changed_files", 0)

          payout_hint = "wait_for_review"
          if pr_merged:
              payout_hint = "request_bounty_payout_now"
          elif pr_state == "closed":
              payout_hint = "pr_closed_without_merge_check_next_action"
          elif review_comments > 0 or comments > 0:
              payout_hint = "review_feedback_available"

          lines = [
              f"[IOTA Bounty Monitor] {now}",
              f"issue_498_state={issue_state}",
              f"pr_569_state={pr_state}",
              f"pr_569_merged={str(pr_merged).lower()}",
              f"pr_mergeable_state={mergeable_state}",
              f"pr_review_comments={review_comments}",
              f"pr_comments={comments}",
              f"pr_commits={commits} changed_files={changed_files}",
              f"payout_action={payout_hint}",
              "issue=https://github.com/iotaledger/iota-rust-sdk/issues/498",
              "pr=https://github.com/iotaledger/iota-rust-sdk/pull/569",
          ]

          with open("status_message.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          with open("status_message.txt", "r", encoding="utf-8") as f:
              message = f.read()
          with open("/tmp/github_output.txt", "w", encoding="utf-8") as f:
              f.write("message<<EOF\n")
              f.write(message)
              f.write("\nEOF\n")
          with open("/tmp/github_output.txt", "r", encoding="utf-8") as src, open(
              __import__("os").environ["GITHUB_OUTPUT"], "a", encoding="utf-8"
          ) as dst:
              dst.write(src.read())
          PY

      - name: Send Telegram update
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MESSAGE: ${{ steps.status.outputs.message }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            --data-urlencode "disable_web_page_preview=true"
